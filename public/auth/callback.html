<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Spotfly - Autenticando...</title>
  <style>
    body {
      background: #121212;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    .container { text-align: center; }
    .spinner {
      width: 40px; height: 40px;
      border: 3px solid #333;
      border-top-color: #1DB954;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    p { font-size: 16px; margin: 8px 0; }
    .hint { font-size: 12px; color: #aaa; margin-top: 16px; }
    .error { color: #ff5252; }
    a { color: #1DB954; }
  </style>
</head>
<body>
  <div class="container" id="container">
    <div class="spinner"></div>
    <p>Autenticando...</p>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js';
    import { getAuth, signInWithCredential, GoogleAuthProvider } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js';

    var container = document.getElementById('container');
    var hash = window.location.hash.substring(1);

    if (!hash) {
      container.innerHTML = '<p class="error">Nenhum token recebido.</p>';
      throw new Error('No hash');
    }

    var params = new URLSearchParams(hash);
    var idToken = params.get('id_token');
    var state = params.get('state') || '';

    if (!idToken) {
      container.innerHTML = '<p class="error">Token n√£o encontrado.</p>';
      throw new Error('No id_token');
    }

    // Detect platform: "web" state = came from web app, otherwise = mobile app
    var isWeb = (state === 'web');

    if (isWeb) {
      // ========================================
      // WEB FLOW: Sign in with Firebase directly here, then redirect to main app
      // ========================================
      try {
        var firebaseConfig = {
          apiKey: 'AIzaSyAlcChuWLkw9-zuf_GAkvU3drg6Hz1NQhc',
          authDomain: 'spotfly-app.firebaseapp.com',
          projectId: 'spotfly-app',
          storageBucket: 'spotfly-app.firebasestorage.app',
          messagingSenderId: '215760117220',
          appId: '1:215760117220:web:62871c1c1fc7f651503bf1',
        };

        var app = initializeApp(firebaseConfig);
        var auth = getAuth(app);
        var credential = GoogleAuthProvider.credential(idToken);
        await signInWithCredential(auth, credential);

        container.innerHTML = '<p>Login realizado! Redirecionando...</p>';
        window.location.href = window.location.origin + '/';
      } catch (e) {
        console.error('Firebase auth error:', e);
        container.innerHTML =
          '<p class="error">Erro ao autenticar: ' + e.message + '</p>' +
          '<p class="hint"><a href="' + window.location.origin + '/">Voltar ao Spotfly</a></p>';
      }
    } else {
      // ========================================
      // MOBILE FLOW: Redirect to app via Intent URI / deep link
      // ========================================
      container.querySelector('p').textContent = 'Redirecionando para o Spotfly...';

      var deepLink = 'spotfly://auth?' + hash;

      // Android Intent URI - most reliable way to open app from Chrome Custom Tab
      var intentUri = 'intent://auth?' + hash +
        '#Intent;scheme=spotfly;package=com.spotfly.app;end;';

      // Try Android Intent first
      window.location.href = intentUri;

      // Fallback: try direct deep link
      setTimeout(function() {
        window.location.href = deepLink;
      }, 500);

      // Show manual fallback link after 2s
      setTimeout(function() {
        container.innerHTML =
          '<p>Redirecionando para o Spotfly...</p>' +
          '<p class="hint">Se nada acontecer, <a href="' + deepLink + '">toque aqui para voltar ao app</a>.</p>';
      }, 2000);
    }
  </script>
</body>
</html>
